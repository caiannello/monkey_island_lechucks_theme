/*
 * lechuck85.c
 *
 * This version is optimized to work on a small attiny85 microcontroller rather than the 
 * .ino file version for Arduino. I have one on a solar panel that just plays lechuck theme
 * whenever there's daylight. :)
 *
 * Created: 11/25/2020 2:00:05 PM
 * Author : Craig Iannello
 */

#include <avr/io.h>
#include <avr/pgmspace.h>
#include <avr/interrupt.h>

const uint16_t song[] PROGMEM = {
0x089e,0x02b4,0x0000,0x018c,0x0885,0x0029,0x07d4,0x0081,0x0a9e,0x01ca,0x089e,0x01ac,0x0000,0x00a7,0x0885,0x016c,
0x0000,0x02d2,0x0885,0x0025,0x07d4,0x0206,0x0000,0x02c2,0x07e0,0x002d,0x07e0,0x0050,0x07e0,0x002d,0x07e0,0x001f,
0x0000,0x031d,0x088d,0x002c,0x07bd,0x0085,0x07e0,0x00a2,0x0000,0x0146,0x0a8d,0x01e0,0x088d,0x01d6,0x088d,0x014c,
0x0000,0x009b,0x088d,0x0030,0x07bd,0x007f,0x0000,0x017d,0x0000,0x01f3,0x08f5,0x006b,0x0b95,0x0025,0x08c8,0x014c,
0x0000,0x02f2,0x07c8,0x0096,0x08c8,0x0101,0x0000,0x00d7,0x0acc,0x0235,0x08c8,0x024e,0x0000,0x01ec,0x07c8,0x0093,
0x0000,0x044e,0x08d4,0x016e,0x0000,0x02d4,0x07d4,0x0081,0x08d4,0x00e2,0x0000,0x00f4,0x0ad8,0x01b2,0x08f2,0x003c,
0x08d4,0x01cb,0x08f5,0x003d,0x08d6,0x002f,0x0000,0x01ba,0x07d4,0x0098,0x0000,0x017d,0x0000,0x01f2,0x0980,0x0020,
0x089e,0x0358,0x0000,0x00e4,0x07d4,0x0095,0x0a9e,0x01dc,0x089e,0x020b,0x0000,0x004b,0x0885,0x01b8,0x0000,0x0287,
0x07d4,0x018b,0x0000,0x033e,0x07bd,0x017e,0x0000,0x02c0,0x07bd,0x01d4,0x0000,0x0099,0x0a8d,0x01cd,0x07e0,0x0050,
0x07e0,0x002d,0x07e0,0x001f,0x07e0,0x001f,0x07e0,0x002d,0x07e0,0x002d,0x07e0,0x001f,0x07e0,0x001f,0x07e0,0x002d,
0x08f6,0x0026,0x08f3,0x0026,0x07e0,0x00b3,0x0000,0x0134,0x07bd,0x007f,0x0000,0x0181,0x0000,0x01f3,0x08f7,0x0036,
0x08f2,0x0026,0x08ee,0x017d,0x0000,0x02c1,0x089f,0x002c,0x07ee,0x0047,0x08ee,0x0176,0x0000,0x006e,0x09f0,0x024b,
0x08ee,0x0158,0x0000,0x02f2,0x089f,0x0022,0x07ef,0x0029,0x07ee,0x0030,0x08ee,0x00e7,0x0000,0x034b,0x08d4,0x03bf,
0x0000,0x007a,0x08a8,0x001f,0x07d4,0x0092,0x0000,0x01e8,0x09d5,0x01d4,0x08f4,0x0054,0x09d5,0x0085,0x0000,0x015f,
0x0000,0x0202,0x07d4,0x0092,0x0000,0x0183,0x0000,0x01ef,0x0982,0x0020,0x089e,0x0358,0x0000,0x00e4,0x07d4,0x008e,
0x0a9e,0x01ca,0x089e,0x01ca,0x0000,0x007a,0x0885,0x019e,0x0000,0x02a0,0x07d4,0x01a9,0x0000,0x031d,0x07e1,0x014e,
0x0000,0x02f0,0x07bd,0x008e,0x07e0,0x001f,0x07e0,0x002d,0x07e0,0x002d,0x0000,0x0122,0x0a8d,0x01df,0x088d,0x01d2,
0x08f3,0x003d,0x088d,0x018f,0x0000,0x005b,0x07bd,0x0091,0x0000,0x0182,0x0000,0x01fe,0x08ee,0x0150,0x0000,0x02ee,
0x07c8,0x0086,0x08ee,0x010d,0x0000,0x00d5,0x09ef,0x023a,0x08ef,0x015f,0x0000,0x02d1,0x089e,0x002c,0x07c8,0x0083,
0x0985,0x0096,0x0000,0x03a6,0x099e,0x0148,0x0000,0x0305,0x07d4,0x0095,0x099e,0x00e5,0x0000,0x00f7,0x0a9e,0x01ca,
0x08f6,0x0026,0x099e,0x01d4,0x08f6,0x0026,0x099e,0x00ef,0x0000,0x0107,0x089f,0x0022,0x07d4,0x0074,0x0000,0x0171,
0x0000,0x01f3,0x08f3,0x0089,0x089e,0x01ca,0x0000,0x0271,0x07c8,0x0099,0x089e,0x015c,0x08f2,0x0025,0x089e,0x002c,
0x09c9,0x0236,0x088d,0x018f,0x0000,0x003d,0x0000,0x0202,0x07c8,0x0077,0x0885,0x0121,0x0000,0x031d,0x088d,0x015e,
0x0000,0x02e0,0x07d4,0x008e,0x08a8,0x00a3,0x0000,0x00ce,0x08f3,0x0044,0x09d5,0x0259,0x08d4,0x01d2,0x08f6,0x0026,
0x08f0,0x0025,0x08d4,0x00a6,0x0000,0x0141,0x07d4,0x007b,0x0000,0x01eb,0x08d4,0x0207,0x0000,0x004c,0x08ee,0x01aa,
0x0000,0x0294,0x07ee,0x0091,0x08ef,0x0149,0x0b84,0x0021,0x09ef,0x0257,0x08d4,0x0167,0x0000,0x006a,0x08f0,0x0025,
0x0000,0x01f3,0x07ee,0x0077,0x08c8,0x0185,0x0000,0x02b3,0x08d4,0x03a5,0x0000,0x009c,0x07d4,0x008e,0x0000,0x0180,
0x09d5,0x024c,0x08d4,0x01cc,0x08d5,0x0071,0x08d4,0x00c1,0x0000,0x00bc,0x07d4,0x006a,0x0000,0x01fb,0x08d4,0x0189,
0x0000,0x00be,0x08ee,0x0158,0x0000,0x02e0,0x08c8,0x001f,0x07ee,0x0086,0x08ee,0x012b,0x0000,0x003f,0x09f0,0x024a,
0x08d4,0x015a,0x0000,0x008a,0x0000,0x01f3,0x08f2,0x003c,0x07ee,0x0061,0x08c8,0x007d,0x0000,0x03bb,0x08d4,0x03bf,
0x0000,0x0089,0x07d4,0x0098,0x0000,0x016e,0x08fa,0x0036,0x08f2,0x0026,0x09d5,0x024c,0x08d4,0x00e9,0x0000,0x00e4,
0x08f6,0x0026,0x08ee,0x0132,0x0000,0x00b9,0x07d4,0x0077,0x0985,0x00c9,0x0000,0x010b,0x098d,0x01b3,0x0000,0x00a3,
0x099e,0x027d,0x0000,0x01be,0x07d4,0x008e,0x0a9e,0x02e1,0x0000,0x00e3,0x08f3,0x002d,0x0000,0x0459,0x07d4,0x008e,
0x0985,0x00f2,0x0000,0x00e6,0x08d4,0x01cb,0x0000,0x008b,0x089e,0x0120,0x0000,0x0135,0x09c9,0x01b8,0x0aff,0x0020,
0x07c8,0x0087,0x089e,0x00e0,0x0000,0x035a,0x08a8,0x015c,0x0000,0x00f4,0x09d5,0x01d4,0x07d4,0x008e,0x08a8,0x00a3,
0x0000,0x039b,0x089e,0x03b2,0x0000,0x008d,0x07d4,0x008e,0x0a9e,0x0166,0x099e,0x01d4,0x08f5,0x0026,0x0000,0x01f3,
0x0000,0x01ef,0x08f2,0x0026,0x07d4,0x0095,0x099e,0x015c,0x0000,0x0202,0x08f5,0x006b,0x0a86,0x027f,0x0000,0x01be,
0x07d4,0x008e,0x099e,0x017a,0x0000,0x005b,0x09d5,0x0358,0x0000,0x015e,0x099e,0x01d4,0x089e,0x0022,0x0885,0x0025,
0x07d4,0x0085,0x0a86,0x01f8,0x0000,0x0243,0x099e,0x01ca,0x0000,0x0271,0x089f,0x0031,0x07d4,0x0088,0x0a9e,0x0166,
0x08f2,0x0062,0x099f,0x01ca,0x08f6,0x0026,0x0000,0x01ff,0x0000,0x01f3,0x089f,0x002c,0x07d4,0x0088,0x099e,0x013e,
0x0ab4,0x002d,0x0000,0x01d9,0x0a86,0x022b,0x0000,0x0217,0x089e,0x002c,0x07d4,0x0088,0x099e,0x017a,0x0000,0x006e,
0x09d5,0x029c,0x0000,0x020a,0x099e,0x01a2,0x0000,0x0040,0x07d4,0x0088,0x0a86,0x0161,0x0000,0x0236
};

#define SONG_LEN    (sizeof(song)/sizeof(const uint16_t))

volatile uint16_t playing=0;
volatile uint8_t  done=0;

ISR(TIMER0_OVF_vect)
{
  if(playing)
    playing--;
  else
    done=1;
}

void init()
{
  cli();

  DDRB =  0b00000010; // all inputs except PB1 (OCR1A)
  PORTB = 0b00011101; // pull-ups on inputs, except set PB1 low

  // timer 0 for note/rest duration
  TCCR0A = 0x00;
  TCCR0B = 0x02;  // 3906.25 rollovers/sec at 8MHz

  // interrupt on rollover of timer 0
  TIMSK = 1 << TOIE0;

  sei();        // enable interrupts
}

void tone(uint16_t note, uint16_t durr)
{
  cli();

  if(note)
  {
    uint8_t rload  = note&0xff;
    OCR1C = rload;
    OCR1A = rload>>1;
    uint8_t pscale = (uint16_t)note>>8;
    TCCR1 = 0b01100000 | pscale;
  } else
  {
    TCCR1 = 0b01100000;
    GTCCR = 2;
  }

  playing = durr;
  done=0;

  sei();

  while(!done);

}

int main(void)
{
  init();
  while (1)
  {
    for(uint16_t n = 0; n < SONG_LEN ; n+=2)
    {
      uint16_t note = pgm_read_word_near(song+n);
      uint16_t durr = pgm_read_word_near(song+n+1);
      tone(note,durr);
    }
  }
}

